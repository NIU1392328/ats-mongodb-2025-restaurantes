// APARTADO 2

// Creacion nueva coleccion 
db.Inspections.aggregate([
  {
    $addFields: {
      restaurant_id: { $toObjectId: "$restaurant_id" } 
    }
  },
  {
    $lookup: {
      from: "Restaurants",
      localField: "restaurant_id",  
      foreignField: "_id",  
      as: "restaurant_info"  
    }
  },
  {
    $unwind: "$restaurant_info"  
  },
  {
    $project: {
      _id: 1,
      certificate_number: 1,
      business_name: 1,
      date: 1,
      result: 1,
      sector: 1,
      address: 1,
      restaurant_info: 1 
    }
  },
  {
    $out: "InspectionsRestaurants" 
  }
]);

// Es quema de validación restaurants
db.runCommand({
  collMod: "restaurants",
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["name", "address"],
      properties: {
        name: {
          bsonType: "string",
          description: "Nombre del restaurante"
        },
        address: {
          bsonType: "object",
          required: ["street", "city", "postcode"],
          properties: {
            street: {
              bsonType: "string",
              description: "Calle y número"
            },
            city: {
              bsonType: "string",
              description: "Ciudad"
            },
            postcode: {
              bsonType: "string",
              description: "Código postal"
            }
          }
        }
      }
    }
  }
});

// Esquema de validacion inspections
db.runCommand({
  collMod: "inspections",
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["restaurant_id", "date", "result"],
      properties: {
        restaurant_id: {
          bsonType: "objectId",
          description: "ID del restaurante asociado"
        },
        date: {
          bsonType: "string",
          pattern: "^\\d{4}-\\d{2}-\\d{2}$",
          description: "Fecha en formato YYYY-MM-DD"
        },
        result: {
          bsonType: "string",
          enum: ["No Violation Issued", "Violation Found", "Pending"],
          description: "Resultado de la inspección"
        }
      }
    }
  }
});

